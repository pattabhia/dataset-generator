# dataset_generator/sections/company_kb.py

from __future__ import annotations

from typing import Any, Dict, List

from .base import SectionBuilder
from ..utils import make_metadata


class CompanyKBTrainingBuilder(SectionBuilder):
    """Section 11 (positive): Company Knowledge Base factual Q&A."""

    @property
    def file_name(self) -> str:
        return "company_kb_training.json"

    def build_examples(self) -> List[Dict[str, Any]]:
        cfg = self.config
        examples: List[Dict[str, Any]] = []

        # Check if real company KB facts are provided via config. If present, use them
        # instead of auto-generated placeholder facts. Facts should be a list of
        # strings, each describing a factual statement about the company.
        facts: List[str] | None = getattr(cfg, "company_kb_facts", None)
        if facts:
            # Use the number of provided facts as the dataset size. If there are
            # fewer than three facts, cycle through templates for diversity.
            for idx, fact in enumerate(facts, start=1):
                system = f"You are {cfg.agent_name}, answer using only {cfg.kb_label}."
                # Use a generic instruction prompting for the fact index.
                # Templates could be extended here for further variation.
                instruction = f"Provide detail {idx} about {cfg.company_name} according to the KB."
                output = fact

                metadata = make_metadata(
                    section="company_kb_positive",
                    index=idx,
                    complexity="low",
                    tags=["company_kb", "positive", "fact"],
                    reasoning_mode="lookup",
                )

                examples.append({
                    "system": system,
                    "instruction": instruction,
                    "input": "",
                    "output": output,
                    "metadata": metadata,
                })
            return examples

        # No real facts provided – fall back to placeholder generation using the
        # original logic with varied question and answer templates. Maintain
        # compatibility with existing datasets by generating a fixed number of
        # examples (n).
        n = 120
        # Varied question prompts and factual templates to improve diversity
        question_templates = [
            "What does the company KB say about {company} detail {idx}?",
            "Give me fact {idx} about {company} from the knowledge base.",
            "Provide detail {idx} about {company} according to the KB.",
        ]
        answer_templates = [
            "{company} detail {idx}: autogenerated placeholder fact for training in the {domain} domain.",
            "Within the {domain} knowledge base, item {idx} for {company} is a placeholder fact used for training.",
            "This is placeholder fact {idx} about {company} used for {domain} KB training.",
        ]

        for idx in range(1, n + 1):
            system = (
                f"You are {cfg.agent_name}, answer using only {cfg.kb_label}."
            )
            q_template = question_templates[idx % len(question_templates)]
            a_template = answer_templates[idx % len(answer_templates)]
            instruction = q_template.format(company=cfg.company_name, idx=idx)
            output = a_template.format(company=cfg.company_name, idx=idx, domain=cfg.domain_name)

            metadata = make_metadata(
                section="company_kb_positive",
                index=idx,
                complexity="low",
                tags=["company_kb", "positive", "fact"],
                reasoning_mode="lookup",
            )

            examples.append({
                "system": system,
                "instruction": instruction,
                "input": "",
                "output": output,
                "metadata": metadata,
            })

        return examples


class CompanyKBNoHallucinationsTrainingBuilder(SectionBuilder):
    """Section 11 (negative): Refuse outside-KB questions."""

    @property
    def file_name(self) -> str:
        return "company_kb_no_hallucinations_training.json"

    def build_examples(self) -> List[Dict[str, Any]]:
        cfg = self.config
        n = 80
        examples: List[Dict[str, Any]] = []

        # Provide variation in hallucination-prevention queries and responses
        question_templates = [
            "This question is not covered by the KB: negative test {idx}.",
            "Hallucination prevention case {idx}: user asks outside the KB scope.",
            "KB negative test {idx}: ask something unrelated to {company}.",
        ]
        response_templates = [
            "I don’t have information about this outside the indexed knowledge base. Please provide relevant documents or context from the KB.",
            "I'm sorry, but that information isn't in our KB. Could you refer to the KB or share a relevant document?",
            "This appears to be outside our knowledge base. I prefer not to guess. Please check the KB for available info.",
        ]

        for idx in range(1, n + 1):
            system = (
                f"You are {cfg.agent_name}. If user asks outside {cfg.kb_label}, refuse safely."
            )
            q_template = question_templates[idx % len(question_templates)]
            r_template = response_templates[idx % len(response_templates)]
            instruction = q_template.format(idx=idx, company=cfg.company_name)
            output = r_template

            metadata = make_metadata(
                section="company_kb_negative",
                index=idx,
                complexity="low",
                tags=["company_kb", "negative", "hallucination"],
                reasoning_mode="refusal",
                is_negative_example=True,
            )

            examples.append({
                "system": system,
                "instruction": instruction,
                "input": "",
                "output": output,
                "metadata": metadata,
            })

        return examples
  
